name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

env:
  AWS_REGION: ap-northeast-2
  DIFY_PRIVATE_IP: 10.0.137.89  # Dify ì„œë²„ í”„ë¼ì´ë¹— IP (í™•ì¸ í•„ìš”!)

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build, tag, and push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
        IMAGE_TAG: latest
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to Private EC2 via Bastion
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ env.DIFY_PRIVATE_IP }}
        username: ec2-user
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        proxy_host: ${{ secrets.BASTION_HOST }}
        proxy_username: ec2-user
        proxy_key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ğŸš€ Starting Deployment..."
          # AWS CLI ë¡œê·¸ì¸ (ECR ê¶Œí•œ íšë“)
          aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin ${{ steps.login-ecr.outputs.registry }} || true
          
          # í´ë” ì´ë™
          cd ~/dify/docker
          
          # docker-compose.yaml ìˆ˜ì • (ì´ë¯¸ì§€ ê²½ë¡œë¥¼ ECRë¡œ ë³€ê²½)
          # (ì£¼ì˜: ì²˜ìŒì—” ìˆ˜ë™ìœ¼ë¡œ ë°”ê¿”ì£¼ëŠ” ê²Œ ì•ˆì „í•˜ì§€ë§Œ, ì—¬ê¸°ì„  sedë¡œ ìë™ êµì²´ ì‹œë„)
          # ë§Œì•½ ë¡œì»¬ ë¹Œë“œ ì´ë¯¸ì§€ë¥¼ ì“°ê³  ìˆë‹¤ë©´ ì´ ë¶€ë¶„ì€ ìŠ¤í‚µí•˜ê³  ìˆ˜ë™ìœ¼ë¡œ íŒŒì¼ ê³ ì¹˜ëŠ” ê²Œ ë‚˜ìŒ.
          
          # ìµœì‹  ì´ë¯¸ì§€ Pull & ì¬ì‹¤í–‰
          # (sqlfluff-api ì„œë¹„ìŠ¤ë§Œ ë¦¬í”„ë ˆì‹œ)
          docker compose pull sqlfluff-api
          docker compose up -d --no-deps sqlfluff-api
          
          # ì•ˆ ì“°ëŠ” ì´ë¯¸ì§€ ì •ë¦¬
          docker image prune -f
          echo "âœ… Deployment Finished!"
